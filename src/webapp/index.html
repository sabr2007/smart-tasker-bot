<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>Smart-Tasker</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Vue 3 (Global Build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <div id="app" v-cloak>
    <!-- Screen: Main App -->
    <div class="app" v-if="!loading">

      <!-- Header -->
      <header class="header">
        <div class="header-title">{{ headerTitle }}</div>
        <button class="icon-btn" @click="openSettings">
          <i data-lucide="settings"></i>
        </button>
      </header>

      <!-- Content -->
      <main class="content">

        <!-- Tab: Tasks -->
        <div v-show="activeTab === 'tasks'">
          <div v-if="tasks.length === 0" class="status-msg">
            –ó–∞–¥–∞—á –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π! üèù
          </div>

          <div v-else>
            <div v-for="group in taskGroups" :key="group.title" class="task-group">
              <div class="group-title">{{ group.title }}</div>
              <div v-for="task in group.items" :key="task.id" class="task-item" @click="openSheet(task)">
                <div class="task-checkbox" :class="{ done: !!task.completed_at }" @click.stop="toggleTask(task)">
                  <i data-lucide="check"></i>
                </div>
                <div class="task-content">
                  <div class="task-text" :class="{ 'text-done': !!task.completed_at }">
                    {{ task.text }}
                    <i v-if="task.has_attachment" data-lucide="paperclip"
                      style="width: 14px; height: 14px; vertical-align: middle; margin-left: 4px; opacity: 0.6;"></i>
                    <i v-if="task.is_recurring" data-lucide="repeat"
                      style="width: 14px; height: 14px; vertical-align: middle; margin-left: 4px; opacity: 0.6;"></i>
                  </div>
                  <div class="task-meta" :class="{ overdue: isOverdue(task) }">
                    <i data-lucide="clock" style="width:12px; height:12px;" v-if="task.due_at"></i>
                    {{ formatDue(task.due_at) }}
                  </div>
                </div>
                <!-- Link Action -->
                <button v-if="task.link_url" class="icon-btn" style="color: var(--tg-theme-link-color); padding: 4px;"
                  @click.stop="window.open(task.link_url, '_blank')">
                  <i data-lucide="external-link" style="width: 18px; height: 18px;"></i>
                </button>
                <!-- Archive Action -->
                <button v-if="task.completed_at" class="icon-btn"
                  style="color: var(--tg-theme-hint-color); padding: 4px;" @click.stop="archiveTask(task)">
                  <i data-lucide="archive" style="width: 18px; height: 18px;"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab: Calendar -->
        <div v-show="activeTab === 'calendar'" class="calendar-view">
          <div class="mini-calendar" style="margin-bottom: 20px;">
            <div class="mc-header">
              <button class="icon-btn small" @click="calPrevMonth"><i data-lucide="chevron-left"></i></button>
              <div class="calendar-title">{{ calendarTitle }}</div>
              <button class="icon-btn small" @click="calNextMonth"><i data-lucide="chevron-right"></i></button>
            </div>
            <div class="mc-grid">
              <div class="mc-day muted" v-for="d in ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']">{{d}}</div>
              <div v-for="day in calendarDays" :key="day.date" class="mc-day" :class="{ 
                  empty: !day.day,
                  today: day.isToday,
                  selected: day.date === selectedDate
                }" @click="day.day && selectDate(day.date)">
                {{ day.day }}
                <div class="cal-dots" v-if="day.hasTasks">
                  <div class="cal-dot"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="group-title">–ó–∞–¥–∞—á–∏ –Ω–∞ {{ formatDate(selectedDate) }}</div>
          <div v-if="calendarTasks.length === 0" class="status-msg" style="padding: 20px 0;">
            –ù–µ—Ç –∑–∞–¥–∞—á
          </div>
          <div v-for="task in calendarTasks" :key="task.id" class="task-item" @click="openSheet(task)">
            <div class="task-checkbox" @click.stop="toggleTask(task)">
              <i data-lucide="check"></i>
            </div>
            <div class="task-content">
              <div class="task-text">
                {{ task.text }}
                <i v-if="task.is_recurring" data-lucide="repeat"
                  style="width: 14px; height: 14px; vertical-align: middle; margin-left: 4px; opacity: 0.6;"></i>
              </div>
              <div class="task-meta">{{ formatTime(task.due_at) }}</div>
            </div>
          </div>
        </div>

      </main>

      <!-- Tabbar (—Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ–≤–µ—Ä–ª–µ—è—Ö) -->
      <div class="tabbar" v-show="!settingsOpen && !archiveOpen">
        <button class="tab-btn" :class="{ active: activeTab === 'tasks' }" @click="activeTab = 'tasks'">
          <i data-lucide="list-todo"></i>
          <span>–ó–∞–¥–∞—á–∏</span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'calendar' }" @click="activeTab = 'calendar'">
          <i data-lucide="calendar"></i>
          <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </button>
      </div>

    </div>

    <!-- Loader -->
    <div class="app-loader" v-else>
      <div class="spinner"></div>
    </div>


    <!-- Bottom Sheet -->
    <div class="sheet-backdrop" :class="{ open: sheet.open }" @click="closeSheet"></div>

    <div class="sheet" :class="{ open: sheet.open }">
      <div class="sheet-handle"></div>

      <!-- Mode: Menu -->
      <div v-if="sheet.mode === 'menu'">
        <div class="sheet-title">{{ sheet.task?.text }}</div>
        <div class="action-list">
          <button class="action-btn" @click="sheet.mode = 'edit'">
            <i data-lucide="edit-3"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
          </button>
          <button class="action-btn" @click="initReschedule">
            <i data-lucide="clock"></i>
            {{ sheet.task?.due_at ? '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–µ–¥–ª–∞–π–Ω' : '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–¥–ª–∞–π–Ω' }}
          </button>
          <button class="action-btn danger" @click="sheet.mode = 'delete'">
            <i data-lucide="trash-2"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
          </button>
        </div>
      </div>

      <!-- Mode: Edit Text -->
      <div v-if="sheet.mode === 'edit'">
        <div class="sheet-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
        <div class="form-group">
          <textarea class="input-field" rows="3" v-model="editForm.text" ref="focusInput"></textarea>
          <button class="primary-btn" @click="saveText" :disabled="!editForm.text.trim()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </div>
      </div>

      <!-- Mode: Reschedule -->
      <div v-if="sheet.mode === 'reschedule'">
        <div class="sheet-title">–î–µ–¥–ª–∞–π–Ω</div>

        <div class="quick-dates">
          <button class="chip" @click="setDeadline('today')">–°–µ–≥–æ–¥–Ω—è</button>
          <button class="chip" @click="setDeadline('tomorrow')">–ó–∞–≤—Ç—Ä–∞</button>
          <button class="chip" @click="setDeadline('next_week')">–°–ª–µ–¥. –Ω–µ–¥–µ–ª—è</button>
          <button class="chip" @click="setDeadline(null)" style="color: var(--tg-theme-destructive-text-color)">
            –£–±—Ä–∞—Ç—å
          </button>
        </div>

        <div class="mini-calendar">
          <!-- Simple date picker logic reusing calendar state or separate? 
                For simplicity reusing separate simplified picker or same logic.
                Let's use a simplified list of days for now or relying on chips + HTML date input as fallback for specific dates -->
          <input type="datetime-local" class="input-field" v-model="editForm.date" style="text-align: center;" />
        </div>
        <button class="primary-btn" @click="saveDeadline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <!-- Mode: Delete Confirm -->
      <div v-if="sheet.mode === 'delete'">
        <div class="sheet-title">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?</div>
        <div class="status-msg" style="padding: 10px 0 20px;">
          –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
        </div>
        <div class="action-list">
          <button class="action-btn danger" @click="deleteTask">
            <i data-lucide="trash-2"></i> –î–∞, —É–¥–∞–ª–∏—Ç—å
          </button>
          <button class="action-btn" @click="sheet.mode = 'menu'">
            –û—Ç–º–µ–Ω–∞
          </button>
        </div>
      </div>

    </div>

    <!-- Settings Overlay -->
    <div class="overlay" v-if="settingsOpen" style="z-index: 60;">
      <!-- ... reusing existing settings structure but Vue-ified ... -->
      <div class="overlay-header">
        <button class="icon-btn" @click="settingsOpen = false"><i data-lucide="x"></i></button>
        <div class="overlay-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="width: 40px"></div>
      </div>
      <div class="overlay-content">
        <div class="menu">
          <!-- Instructions -->
          <div class="menu-item" @click="showInstructions = !showInstructions">
            <div class="menu-left">
              <div class="menu-icon"><i data-lucide="book-open"></i></div>
              <div class="menu-title">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>
            </div>
            <div class="menu-right">
              <i :data-lucide="showInstructions ? 'chevron-up' : 'chevron-down'"></i>
            </div>
          </div>

          <div v-if="showInstructions" class="instructions-block">
            <p> <b>–ö–∞–∫ —è —Ä–∞–±–æ—Ç–∞—é:</b></p>
            <p>1. <b>–ü–∏—à–∏ –∫–∞–∫ –¥—É–º–∞–µ—à—å:</b> ¬´–ù–∞–ø–æ–º–Ω–∏ –∫—É–ø–∏—Ç—å —Ö–ª–µ–± –∑–∞–≤—Ç—Ä–∞ –≤ 18:00¬ª</p>
            <p>2. <b>–ì–æ–ª–æ—Å–æ–≤—ã–µ:</b> –î–∏–∫—Ç—É–π —Å–ø–∏—Å–æ–∫ –¥–µ–ª, —è —Å–∞–º –≤—Å—ë —Ä–∞–∑–±–µ—Ä—É.</p>
            <p>3. <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</b> –ñ–º–∏ –Ω–∞ –∑–∞–¥–∞—á—É, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å, –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.</p>
            <p>4. <b>–í —á–∞—Ç–µ:</b> ¬´–ü–µ—Ä–µ–Ω–µ—Å–∏ –≤—Å—Ç—Ä–µ—á—É –Ω–∞ 19:00¬ª, ¬´–£–¥–∞–ª–∏ –∑–∞–¥–∞—á—É –ø—Ä–æ —Ç–æ—Ä—Ç¬ª.</p>
          </div>

          <!-- Timezone Selector -->
          <div class="menu-item" style="flex-direction: column; align-items: stretch; gap: 10px;">
            <div class="menu-left" style="width: 100%;">
              <div class="menu-icon"><i data-lucide="globe"></i></div>
              <div class="menu-title">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</div>
            </div>
            <div style="display: flex; gap: 8px; width: 100%; padding-left: 40px;">
              <select v-model="selectedTimezone" class="input-field" style="flex: 1; padding: 8px 12px;">
                <option v-for="tz in COMMON_TIMEZONES" :key="tz.value" :value="tz.value">
                  {{ tz.label }}
                </option>
              </select>
              <button class="primary-btn" style="padding: 8px 16px; min-width: auto;" @click="saveTimezone"
                :disabled="savingTimezone || selectedTimezone === userTimezone">
                {{ savingTimezone ? '...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
              </button>
            </div>
          </div>

          <!-- Archive -->
          <div class="menu-item" @click="openArchive">
            <div class="menu-left">
              <div class="menu-icon"><i data-lucide="archive"></i></div>
              <div class="menu-title">–ê—Ä—Ö–∏–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö</div>
            </div>
            <div class="menu-right"><i data-lucide="chevron-right"></i></div>
          </div>

          <div class="menu-item">
            <div class="menu-left">
              <div class="menu-title">–í–µ—Ä—Å–∏—è</div>
              <div class="menu-sub">2.1 (Vue Edition)</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Archive Overlay -->
    <div class="overlay" v-if="archiveOpen" style="z-index: 61;">
      <div class="overlay-header">
        <button class="icon-btn" @click="archiveOpen = false"><i data-lucide="arrow-left"></i></button>
        <div class="overlay-title">–ê—Ä—Ö–∏–≤</div>
        <button class="icon-btn danger" @click="clearArchive" v-if="archiveTasks.length > 0">
          <i data-lucide="trash-2"></i>
        </button>
        <div style="width: 40px" v-else></div>
      </div>
      <div class="overlay-content">
        <div v-if="loadingArchive" class="status-msg">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div v-else-if="archiveTasks.length === 0" class="status-msg">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>
        <div v-else>
          <div v-for="task in archiveTasks" :key="task.id" class="task-item" style="opacity: 0.7;">
            <div class="task-checkbox done">
              <i data-lucide="check"></i>
            </div>
            <div class="task-content">
              <div class="task-text" style="text-decoration: line-through;">{{ task.text }}</div>
              <div class="task-meta">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ formatDue(task.completed_at) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="/main.js"></script>
</body>

</html>